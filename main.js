const{app:e,BrowserWindow:n,ipcMain:s,dialog:o,nativeImage:r}=require("electron"),t=require("path"),{autoUpdater:a}=require("electron-updater"),i=require("./selfkick");let d;i.emitter.on("log",(e=>{d&&d.webContents.send("selfkick-log",e)}));let l=!1;if(e.requestSingleInstanceLock()){function c(){d=new n({autoHideMenuBar:!0,width:1200,height:800,title:"BlocksMC Tracker",webPreferences:{contextIsolation:!0,preload:t.join(__dirname,"preload.js")}}),d.loadFile(t.join(__dirname,"public","index.html")),d.on("closed",(()=>{d=null}))}e.on("second-instance",(()=>{d&&(d.isMinimized()&&d.restore(),d.focus())})),e.whenReady().then((()=>{c(),a.autoDownload=!1,a.on("update-available",(e=>{console.log(`Update available: version ${e.version}`),o.showMessageBoxSync(d,{type:"info",title:"New update detected",message:`A new version (${e.version}) is available. Do you want to update now?`,buttons:["Update Now","Later"],defaultId:0,cancelId:1,modal:!0,alwaysOnTop:!0}).then((e=>{0===e.response?(console.log("User accepted update, starting download..."),a.downloadUpdate()):console.log("User postponed the update.")}))})),a.on("update-downloaded",(n=>{console.log("Update downloaded; quitting and installing update...");const s=require("fs"),{spawn:o}=require("child_process"),r="C:\\BlocksMC_TrackerData";s.existsSync(r)||s.mkdirSync(r,{recursive:!0});const a=t.basename(n.downloadedFile),i=t.join(r,a);s.copyFile(n.downloadedFile,i,(n=>{if(n)return void console.error("Error copying update file: ",n);console.log(`Copied update file to: ${i}`);o(i,[],{detached:!0,stdio:"ignore"}).unref(),e.quit()}))})),a.on("error",(e=>{console.error("Auto updater error:",e)})),a.checkForUpdates()})),s.on("checkBan",((e,n)=>{const{createBotInstance:s}=require("./bot");s(n,(n=>{"result"===n.type?e.sender.send("banResult",n.message):"log"===n.type&&e.sender.send("kickLog",n.message)}))})),s.on("startNamesniper",((e,n)=>{const{targetUuid:s}=n,{startSniper:o,readUserOGStore:r}=require("./namesniper");o(s,(n=>{"claimed"===n.type?(e.sender.send("namesniperClaimed",n.message),e.sender.send("ogUsernames",r())):"alert"===n.type?e.sender.send("namesniperAlert",n.message):"info"===n.type?e.sender.send("namesniperInfo",n.message):"error"===n.type&&e.sender.send("namesniperError",n.message)}))})),s.on("stopNamesniper",(e=>{const{stopSniper:n}=require("./namesniper");n((n=>{e.sender.send("namesniperStopped",n.message);const{readUserOGStore:s}=require("./namesniper");e.sender.send("ogUsernames",s())}))})),s.on("getOGUsernames",(e=>{const{readUserOGStore:n}=require("./namesniper");e.sender.send("ogUsernames",n())}));const p=t.join(__dirname,"public","TrackerIcon.png"),u=r.createFromPath(p);s.on("show-alert",((e,n)=>{const s={type:"error",title:"BlocksMC Tracker",message:n,buttons:["OK"],icon:u,modal:!0,alwaysOnTop:!0,noLink:!0};o.showMessageBoxSync(d,s),e.returnValue=!0})),s.on("show-confirm",((e,n)=>{const s={type:"question",title:"BlocksMC Tracker",message:n,buttons:["Cancel","OK"],cancelId:0,defaultId:1,icon:u,modal:!0,alwaysOnTop:!0},r=o.showMessageBoxSync(d,s);e.returnValue=1===r})),s.on("enable-selfkick",(e=>{l||(i.startSelfkick(),l=!0,e.sender.send("selfkick-status","started"))})),s.on("disable-selfkick",(e=>{l&&(i.stopSelfkick(),l=!1,e.sender.send("selfkick-status","stopped"))})),e.on("window-all-closed",(()=>{e.quit()})),e.on("quit",(()=>{process.exit(0)})),e.on("activate",(()=>{null===d&&c()}))}else e.quit();