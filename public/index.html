<!DOCTYPE html>
<html lang="en">
<head>
  <!-- L1 -->
  <meta charset="UTF-8">
  <!-- L2 -->
  <title>BlocksMC Ban Tracker Website</title>
  <!-- L3 -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- L4 -->
  <style>
    /* (Your existing CSS stays unchanged) */
    /* ---------- Base Styles (Legacy Default) ---------- */ /* L5 */
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      overflow-x: hidden;
    }
    /* Legacy theme (default) */
    body.legacy-theme {
      background-color: #f5f5f5;
      color: #000;
    }
    /* Pink (Valentineâ€™s) theme */
    body.pink-theme {
      background-color: #000;
      color: #fff;
    }
    /* ... rest of your CSS ... */
  </style>
</head>
<body>
  <!-- Theme Toggle Button (Top Left) --> <!-- L100 -->
  <div id="themeToggle">Theme: Legacy</div>
  
  <!-- Floating Hearts (Pink Theme Only) --> <!-- L102 -->
  <div id="heartsContainer">
    <img src="pinkheart.png" alt="Heart" class="heart">
    <img src="pinkheart.png" alt="Heart" class="heart">
    <img src="pinkheart.png" alt="Heart" class="heart">
    <img src="pinkheart.png" alt="Heart" class="heart">
  </div>
  
  <!-- Note at the website discontinued --> <!-- L109 -->
  <div class="download-note">
    Warning: This website is discontinued and won't get any updates! To get updates download our app from <a href="https://github.com/ForgedSengoku/BlocksMCTracker/releases" style="color: red; text-decoration: underline;">GitHub Releases</a><br>
    In our electron app we have sounds and more features like OG Username Tracker, but the website is limited to ban tracker only!
  </div>
  
  <!-- Audio elements for sound effects --> <!-- L116 -->
  <audio id="buttonSound" src="buttonOnPressed.ogg" preload="auto"></audio> <!-- L117 -->
  <audio id="errorSound" src="Error.ogg" preload="auto"></audio> <!-- L118 -->
  <audio id="unbannedSound" src="StatusPlayerUnbanned.ogg" preload="auto"></audio> <!-- L119 -->

  <!-- Warning Message --> <!-- L121 -->
  <div id="warningMessage"></div>
  
  <!-- Reset Cookies Button --> <!-- L123 -->
  <button id="resetCookiesBtn" class="reset-cookies-btn">Erase Usernames List</button>

  <div class="container"> <!-- L126 -->
    <h1>
      <img src="TrackerIcon.png" alt="Icon">
      BlocksMC Tracker Tool
    </h1>
    
    <!-- Last Check Info --> <!-- L131 -->
    <div id="lastCheckInfo" style="display:none;"></div>
    
    <label for="username">Enter a username to check ban status:</label> <!-- L134 -->
    <input type="text" id="username" placeholder="Enter username" maxlength="16"> <!-- L135 -->
    <button id="checkBtn">Check</button> <!-- L136 -->

    <div class="ban-log" id="banLog"> <!-- L138 -->
      <h2>Ban Log</h2>
      <ul id="logList"></ul>
    </div>
    
    <!-- Previous Usernames Section --> <!-- L143 -->
    <div id="prevContainer" style="display:none;">
      <h2>Previous Usernames</h2>
      <div id="prevList"></div>
    </div>
    
    <!-- FAQ Section (All FAQs restored) --> <!-- L148 -->
    <div class="faq-section">
      <h2>FAQ</h2>
      <!-- (FAQ items remain unchanged) -->
    </div>
    
  </div>

  <!-- Removed Socket.IO Client Library -->

  <script>
    // ---------- Cookie Utility Functions ---------- //
    function setCookie(name, value, days) {
      var expires = "";
      if (days) {
        var date = new Date();
        date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
        expires = "; expires=" + date.toUTCString();
      }
      document.cookie = name + "=" + (value || "") + expires + "; path=/";
    }
    function getCookie(name) {
      var nameEQ = name + "=";
      var ca = document.cookie.split(';');
      for (var i = 0; i < ca.length; i++) {
        var c = ca[i];
        while (c.charAt(0) === ' ') c = c.substring(1, c.length);
        if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
      }
      return null;
    }
    
    // ---------- Theme Toggle Functions ---------- //
    function updateTheme() {
      var pink = getCookie("pinkdesign");
      if (pink === "true") {
        document.body.classList.remove("legacy-theme");
        document.body.classList.add("pink-theme");
        document.getElementById("themeToggle").textContent = "Theme: Pink";
      } else {
        document.body.classList.remove("pink-theme");
        document.body.classList.add("legacy-theme");
        document.getElementById("themeToggle").textContent = "Theme: Legacy";
      }
    }
    function toggleTheme() {
      var pink = getCookie("pinkdesign");
      if (pink === "true") {
        setCookie("pinkdesign", "false", 7);
        setCookie("legacydesign", "true", 7);
      } else {
        setCookie("pinkdesign", "true", 7);
        setCookie("legacydesign", "false", 7);
      }
      updateTheme();
    }
    updateTheme();
    document.getElementById("themeToggle").addEventListener("click", toggleTheme);
    
    const colorMap = { /* ... your colorMap remains unchanged ... */ };
    
    function parseMinecraftMessage(jsonString) {
      try {
        const data = JSON.parse(jsonString);
        if (!data.extra || !Array.isArray(data.extra)) return jsonString;
        let html = '';
        data.extra.forEach(part => {
          let text = part.text || '';
          text = text.replace(/\n/g, '<br>');
          const cssColor = colorMap[part.color] || part.color || '#FFFFFF';
          const boldStyle = part.bold ? 'font-weight:bold;' : '';
          html += `<span style="color:${cssColor}; ${boldStyle}">${text}</span>`;
        });
        return html;
      } catch (e) {
        return jsonString;
      }
    }
    function renderMessage(message) {
      const prefix = "Kicked: ";
      if (message.startsWith(prefix)) {
        const jsonPart = message.substring(prefix.length);
        return prefix + parseMinecraftMessage(jsonPart);
      }
      return parseMinecraftMessage(message);
    }
    
    // ---------- Previous Usernames and Last Check Info ---------- //
    function getPrevUsers() {
      const data = getCookie("prevUsers");
      return data ? JSON.parse(data) : {};
    }
    function setPrevUsers(obj) {
      setCookie("prevUsers", JSON.stringify(obj), 7);
    }
    function updatePrevList() {
      const prevUsers = getPrevUsers();
      const prevContainer = document.getElementById("prevContainer");
      const prevList = document.getElementById("prevList");
      prevContainer.style.display = Object.keys(prevUsers).length > 0 ? "block" : "none";
      prevList.innerHTML = "";
      for (let user in prevUsers) {
        const entry = prevUsers[user];
        const div = document.createElement("div");
        div.className = "prevEntry";
        
        // Create and add the player's head image (32px)
        const headImg = document.createElement("img");
        headImg.src = "https://minotar.net/helm/" + user;
        headImg.alt = user + "'s head";
        headImg.style.width = "32px";
        headImg.style.height = "32px";
        headImg.style.marginRight = "10px";
        div.appendChild(headImg);
        
        const unameSpan = document.createElement("span");
        unameSpan.className = "prevUsername";
        unameSpan.textContent = user;
        
        const statusSpan = document.createElement("span");
        if (entry.status.startsWith("Not banned") || entry.status === "Unbanned") {
          statusSpan.className = "prevStatus statusNotBanned";
        } else if (entry.status.startsWith("Banned")) {
          statusSpan.className = "prevStatus statusBanned";
        } else if (entry.status.startsWith("Premium Account")) {
          statusSpan.className = "prevStatus statusChecking";
        } else if (entry.status === "Unbanned but player is playing right now") {
          statusSpan.className = "prevStatus statusLoggedIn";
        } else {
          statusSpan.className = "prevStatus statusChecking";
        }
        statusSpan.textContent = entry.status;
        
        const countSpan = document.createElement("span");
        countSpan.className = "prevCount";
        countSpan.textContent = "Recheck count: " + entry.count;
        
        const recheckButton = document.createElement("button");
        recheckButton.className = "recheckBtn";
        recheckButton.textContent = "ReCheck";
        recheckButton.disabled = entry.status.startsWith("Banned") || entry.status.startsWith("Premium Account");
        recheckButton.addEventListener("click", () => {
          document.getElementById("username").value = user;
          document.getElementById("checkBtn").click();
        });
        
        div.appendChild(unameSpan);
        div.appendChild(statusSpan);
        div.appendChild(countSpan);
        div.appendChild(recheckButton);
        prevList.appendChild(div);
      }
    }
    
    function updateLastCheckInfo() {
      const lastUsername = getCookie("lastUsername");
      const lastBanStatus = getCookie("lastBanStatus");
      let displayStatus = lastBanStatus;
      if (lastBanStatus && lastBanStatus.includes("<span")) {
        displayStatus = "The player is currently not banned";
      }
      if (lastUsername) {
        const lastCheckInfo = document.getElementById("lastCheckInfo");
        lastCheckInfo.style.display = "block";
        lastCheckInfo.innerHTML = `
          <strong>Last Checked:</strong> ${lastUsername} <br>
          <strong>Status:</strong> ${displayStatus ? displayStatus : "Unknown"} 
          <br><button id="recheckBtnLast">Re-check this username</button>
        `;
        document.getElementById("recheckBtnLast").addEventListener("click", () => {
          document.getElementById("username").value = lastUsername;
          document.getElementById("checkBtn").click();
        });
      }
    }
    updateLastCheckInfo();
    updatePrevList();
    
    // ---------- Check Button Event Handler using HTTPS POST ----------
    const checkBtn = document.getElementById('checkBtn');
    const usernameInput = document.getElementById('username');
    const logList = document.getElementById('logList');
    let currentUsername = "";
    
    usernameInput.addEventListener('keydown', (e) => {
      if (e.key === ' ') e.preventDefault();
    });
    
    checkBtn.addEventListener('click', () => {
      // Play button sound
      document.getElementById('buttonSound').play().catch(console.error);
      
      const username = usernameInput.value.trim();
      const validUsernameRegex = /^[a-zA-Z0-9_]{3,16}$/;
      if (!validUsernameRegex.test(username)) {
        document.getElementById('errorSound').play().catch(console.error);
        alert("Invalid username. Please use only letters, numbers, and underscores (3-16 characters) with no spaces.");
        return;
      }
      currentUsername = username;
      setCookie("lastUsername", username, 7);
      
      const prevUsers = getPrevUsers();
      if (prevUsers[username]) {
        prevUsers[username].count++;
        prevUsers[username].status = "Checking...";
      } else {
        prevUsers[username] = { count: 1, status: "Checking..." };
      }
      setPrevUsers(prevUsers);
      updatePrevList();
      
      checkBtn.disabled = true;
      checkBtn.textContent = "Please wait 7 seconds...";
      setTimeout(() => { checkBtn.textContent = "Please wait 6 seconds..."; }, 1000);
      setTimeout(() => { checkBtn.textContent = "Please wait 4 seconds..."; }, 3000);
      setTimeout(() => { checkBtn.textContent = "Please wait 2 seconds..."; }, 5000);
      setTimeout(() => {
        checkBtn.disabled = false;
        checkBtn.textContent = "Check";
      }, 7000);
      
      // Clear previous log
      logList.innerHTML = "";
      
      // Use fetch to send a POST request over HTTPS
      fetch('/checkBan', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ username: username })
      })
      .then(response => response.json())
      .then(data => {
        const message = data.message;
        const li = document.createElement('li');
        li.innerHTML = renderMessage(message);
        logList.appendChild(li);
        setCookie("lastBanStatus", message, 7);
        updateLastCheckInfo();
        
        const prevUsers = getPrevUsers();
        let status = "";
        if (message.indexOf('"color":"green","text":"Premium ON') !== -1) {
          status = "Premium Account - Unable To Check. NOTE: You won't be able to check premium accounts due to BlocksMC restrictions.";
        } else if (message.toLowerCase().includes("you are already logged on to this server")) {
          status = "Unbanned but player is playing right now";
        } else {
          status = message.toLowerCase().includes("not banned") ? "Not banned" : "Banned";
        }
        if (prevUsers[currentUsername]) {
          prevUsers[currentUsername].status = status;
        }
        setPrevUsers(prevUsers);
        updatePrevList();
        
        if (status === "Not banned" || status === "Unbanned but player is playing right now") {
          document.getElementById('unbannedSound').play().catch(console.error);
        }
      })
      .catch(err => {
        console.error(err);
        document.getElementById('errorSound').play().catch(console.error);
      });
    });
    
    // ---------- Reset Cookies Button ----------
    document.getElementById('resetCookiesBtn').addEventListener('click', function() {
      if (confirm("Warning: All previous usernames will be erased. Are you sure you want to continue?")) {
        setCookie("prevUsers", "", -1);
        updatePrevList();
        alert("All list of previous usernames were reset.");
      }
    });
  </script>
</body>
</html>
